#!/bin/bash
ask(){
        read -p "$@" x
        printf '%s\n' "$x"
}

if [[ -z $AWS_ACCESS_KEY_ID ]]; then
        export AWS_ACCESS_KEY_ID=$(ask "AWS_ACCESS_KEY_ID: ")
fi
if [[ -z $AWS_SECRET_ACCESS_KEY ]]; then
        export AWS_SECRET_ACCESS_KEY=$(ask "AWS_SECRET_ACCESS_KEY: ")
fi

if [[ -z $AWS_DEFAULT_REGION ]]; then
        export AWS_DEFAULT_REGION="ap-south-1"
fi

num=$(aws ec2 describe-instances | jq '.Reservations[].Instances | length')

if [[ $num != '' ]]; then
    printf '%s\n' "There's already an instance running. bailing out."
    exit 1
fi

cmd=(aws ec2 run-instances \
	 --image-id "ami-0f918f7e67a3323f0" \
	 --subnet-id "subnet-02e7f17ee115e10c6" \
	 --instance-type "t2.micro" \
	 --user-data file://cloud-init.sh )

printf '%s\n' "${cmd[*]}"
read -p "run?(y/n)" ans
if [[ $ans == 'y' ]]; then
    "${cmd[@]}"
fi
